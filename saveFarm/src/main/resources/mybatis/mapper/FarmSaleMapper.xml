<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sp.app.farm.mapper.FarmSaleMapper">


  <!-- 월별 품목별 총중량(g) — 품목번호/정확명/유사명 필터 + Top N -->
  <select id="listMonthlyVarietyWeight" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH agg AS (
      SELECT
        TO_CHAR(po.orderStateDate, 'YYYY-MM')                 AS monthKey,
        v.varietyName                                         AS varietyName,
        SUM(NVL(od.qty,0) * TO_NUMBER(NVL(pd.unit,'0')))      AS totalWeightG
      FROM productOrder  po
      JOIN orderDetail   od ON od.orderNum   = po.orderNum
      JOIN detailState   ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN Product       p  ON p.productNum  = od.productNum
      JOIN ProductDetail pd ON pd.productNum = od.productNum
      JOIN variety       v  ON v.varietyNum  = p.varietyNum
      WHERE ds.detailState = 1
        AND po.orderStateDate &gt;= TRUNC(TO_DATE(#{startYm}, 'YYYYMM'), 'MM')
        AND po.orderStateDate &lt;  ADD_MONTHS(TRUNC(TO_DATE(#{endYm},   'YYYYMM'), 'MM'), 1)

        <!-- 품목번호 필터 (옵션) -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <!-- 정확 명칭 필터 (옵션) -->
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <!-- 유사 명칭 필터 (옵션) -->
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>

      GROUP BY TO_CHAR(po.orderStateDate, 'YYYY-MM'), v.varietyName
    )
    SELECT monthKey, varietyName, totalWeightG
    FROM (
      SELECT a.*,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY totalWeightG DESC) AS rn
      FROM agg a
    ) x
    WHERE 1=1
      <if test="topN != null">AND rn &lt;= #{topN}</if>
    ORDER BY monthKey, totalWeightG DESC
  </select>

  <!-- 월별 품목별 총금액 — 품목번호/정확명/유사명 필터 + Top N -->
  <select id="listMonthlyVarietyAmount" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH agg AS (
      SELECT
        TO_CHAR(po.orderStateDate, 'YYYY-MM')            AS monthKey,
        v.varietyName                                    AS varietyName,
        SUM(NVL(od.qty,0) * NVL(od.salePrice,0))         AS totalAmount
      FROM productOrder  po
      JOIN orderDetail   od ON od.orderNum   = po.orderNum
      JOIN detailState   ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN Product       p  ON p.productNum  = od.productNum
      JOIN variety       v  ON v.varietyNum  = p.varietyNum
      WHERE ds.detailState = 1  
        AND po.orderStateDate &gt;= TRUNC(TO_DATE(#{startYm}, 'YYYYMM'), 'MM')
        AND po.orderStateDate &lt;  ADD_MONTHS(TRUNC(TO_DATE(#{endYm},   'YYYYMM'), 'MM'), 1)

        <!-- 품목번호 필터 (옵션) -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <!-- 정확 명칭 필터 (옵션) -->
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <!-- 유사 명칭 필터 (옵션) -->
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>

      GROUP BY TO_CHAR(po.orderStateDate, 'YYYY-MM'), v.varietyName
    )
    SELECT monthKey, varietyName, totalAmount
    FROM (
      SELECT a.*,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY totalAmount DESC) AS rn
      FROM agg a
    ) x
    WHERE 1=1
      <if test="topN != null">AND rn &lt;= #{topN}</if>
    ORDER BY monthKey, totalAmount DESC
  </select>

  <!-- 하나의 쿼리로 (월/품목별) 총중량 + 총금액을 함께 반환 -->
  <select id="listMonthlyVarietyWeightAndAmount" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH agg AS (
      SELECT
        TO_CHAR(po.orderStateDate, 'YYYY-MM')                 AS monthKey,
        v.varietyName                                         AS varietyName,
        SUM(NVL(od.qty,0) * TO_NUMBER(NVL(pd.unit,'0')))      AS totalWeightG,
        SUM(NVL(od.qty,0) * NVL(od.salePrice,0))              AS totalAmount
      FROM productOrder  po
      JOIN orderDetail   od ON od.orderNum   = po.orderNum
      JOIN detailState   ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN Product       p  ON p.productNum  = od.productNum
      JOIN ProductDetail pd ON pd.productNum = od.productNum
      JOIN variety       v  ON v.varietyNum  = p.varietyNum
      WHERE ds.detailState = 1 
        AND po.orderStateDate &gt;= TRUNC(TO_DATE(#{startYm}, 'YYYYMM'), 'MM')
        AND po.orderStateDate &lt;  ADD_MONTHS(TRUNC(TO_DATE(#{endYm},   'YYYYMM'), 'MM'), 1)

        <!-- 품목 필터들 (옵션) -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>

      GROUP BY TO_CHAR(po.orderStateDate, 'YYYY-MM'), v.varietyName
    )
    SELECT monthKey, varietyName, totalWeightG, totalAmount
    FROM (
      SELECT a.*,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY totalWeightG DESC) AS weightRn,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY totalAmount DESC)  AS amountRn
      FROM agg a
    ) x
    WHERE 1=1
      <if test="topN != null">
        <choose>
          <when test="rankBy == 'amount'">
            AND amountRn &lt;= #{topN}
          </when>
          <otherwise>
            AND weightRn &lt;= #{topN}
          </otherwise>
        </choose>
      </if>
    ORDER BY monthKey,
      <choose>
        <when test="rankBy == 'amount'"> totalAmount DESC </when>
        <otherwise>                      totalWeightG DESC </otherwise>
      </choose>
  </select>

  <!-- 달별 · 품목별 평균 별점 (각 달의 합 ÷ 각 달의 개수) -->
  <select id="listMonthlyAvgStarByVariety" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH base AS (
      SELECT
        TO_CHAR(pr.reviewDate, 'YYYY-MM') AS monthKey,
        v.varietyName                     AS varietyName,
        pr.star                           AS star
      FROM productReview  pr
      JOIN orderDetail    od ON od.orderDetailNum = pr.orderDetailNum
      JOIN detailState    ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN productOrder   po ON po.orderNum       = od.orderNum
      JOIN Product        p  ON p.productNum      = od.productNum
      JOIN variety        v  ON v.varietyNum      = p.varietyNum
      WHERE ds.detailState = 1 
        AND pr.reviewDate &gt;= TRUNC(TO_DATE(#{startYm}, 'YYYYMM'), 'MM')
        AND pr.reviewDate &lt;  ADD_MONTHS(TRUNC(TO_DATE(#{endYm},   'YYYYMM'), 'MM'), 1)

        <!-- 품목 필터 (원하는 조건만 주입) -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>
    ),
    agg AS (
      SELECT
        monthKey,
        varietyName,
        ROUND(SUM(star) / NULLIF(COUNT(star), 0), 2) AS avgStar,
        COUNT(star)                                  AS reviewCount
      FROM base
      GROUP BY monthKey, varietyName
    )
    SELECT monthKey, varietyName, avgStar, reviewCount
    FROM (
      SELECT a.*,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY avgStar DESC, reviewCount DESC) AS rn
      FROM agg a
    ) x
    WHERE 1=1
      <if test="minReviewsPerMonth != null">AND reviewCount &gt;= #{minReviewsPerMonth}</if>
      <if test="topN != null">AND rn &lt;= #{topN}</if>
    ORDER BY monthKey, avgStar DESC, reviewCount DESC;
  </select>

  <!-- 단일 월 – 품목별 평균 별점 (Top N 옵션) -->
  <select id="getMonthlyAvgStarByVariety" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH base AS (
      SELECT
        TO_CHAR(pr.reviewDate, 'YYYY-MM') AS monthKey,
        v.varietyName                     AS varietyName,
        pr.star                           AS star
      FROM productReview  pr
      JOIN orderDetail    od ON od.orderDetailNum = pr.orderDetailNum
      JOIN detailState    ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN productOrder   po ON po.orderNum       = od.orderNum
      JOIN Product        p  ON p.productNum      = od.productNum
      JOIN variety        v  ON v.varietyNum      = p.varietyNum
      WHERE ds.detailState = 1  
        AND TRUNC(pr.reviewDate, 'MM') = TO_DATE(#{ym}, 'YYYYMM')

        <!-- 품목 필터(옵션) -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>
    ),
    agg AS (
      SELECT
        monthKey,
        varietyName,
        ROUND(SUM(star) / NULLIF(COUNT(star), 0), 2) AS avgStar,
        COUNT(star)                                  AS reviewCount
      FROM base
      GROUP BY monthKey, varietyName
    )
    SELECT monthKey, varietyName, avgStar, reviewCount
    FROM (
      SELECT a.*,
             ROW_NUMBER() OVER (PARTITION BY monthKey ORDER BY avgStar DESC, reviewCount DESC) AS rn
      FROM agg a
    ) x
    WHERE 1=1
      <if test="minReviewsPerMonth != null">AND reviewCount &gt;= #{minReviewsPerMonth}</if>
      <if test="topN != null">AND rn &lt;= #{topN}</if>
    ORDER BY monthKey, avgStar DESC, reviewCount DESC;
  </select>

  <!-- 달별 전체 평균 별점 (월별 전체 평균 별점 (품목 구분 없음)) -->	
  <select id="listMonthlyAvgStarOverall" parameterType="map" resultType="com.sp.app.farm.model.MonthlyVarietyStats">
    WITH base AS (
      SELECT
        TO_CHAR(pr.reviewDate, 'YYYY-MM') AS monthKey,
        pr.star                           AS star
      FROM productReview  pr
      JOIN orderDetail    od ON od.orderDetailNum = pr.orderDetailNum
      JOIN detailState    ds ON ds.orderDetailNum = od.orderDetailNum   <!-- 추가 -->
      JOIN productOrder   po ON po.orderNum       = od.orderNum
      JOIN Product        p  ON p.productNum      = od.productNum
      JOIN variety        v  ON v.varietyNum      = p.varietyNum
      WHERE ds.detailState = 1  
        AND pr.reviewDate &gt;= TRUNC(TO_DATE(#{startYm}, 'YYYYMM'), 'MM')
        AND pr.reviewDate &lt;  ADD_MONTHS(TRUNC(TO_DATE(#{endYm},   'YYYYMM'), 'MM'), 1)

        <!-- (옵션) 특정 품목만 월평균을 보고 싶다면 필터 사용 -->
        <if test="varietyNum != null">
          AND v.varietyNum = #{varietyNum}
        </if>
        <if test="varietyName != null and varietyName != ''">
          AND v.varietyName = #{varietyName}
        </if>
        <if test="varietyNameLike != null and varietyNameLike != ''">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{varietyNameLike}) || '%'
        </if>
    ),
    agg AS (
      SELECT
        monthKey,
        ROUND(SUM(star) / NULLIF(COUNT(star), 0), 2) AS avgStar,
        COUNT(star)                                  AS reviewCount
      FROM base
      GROUP BY monthKey
    )
    SELECT monthKey, avgStar, reviewCount
    FROM agg
    <if test="minReviewsPerMonth != null">
    WHERE reviewCount &gt;= #{minReviewsPerMonth}
    </if>
    ORDER BY monthKey;
  </select>



<!--                                                                                                          - -->

<!-- 내농가 판매 조회 관련 쿼리-->

<!-- 상단 총 벌은 금액 -->
<select id="myFarmTotalEarning" parameterType="map" resultType="java.math.BigDecimal">
  SELECT NVL(SUM(
    TO_NUMBER(NVL(s.supplyQuantity,0))
    / NULLIF(TO_NUMBER(NVL(s.unitQuantity,1)), 0)
    * TO_NUMBER(NVL(s.unitPrice,0))
  ), 0) AS totalEarning
  FROM supply s
  WHERE s.farmNum = #{farmNum}
    AND s.state &gt;= 5
    AND s.approvedDate IS NOT NULL
    <if test="productNumOnly != null and productNumOnly == 1">
      AND s.productNum IS NOT NULL
    </if>
</select>


<!-- 품종별 리스트 -->
<select id="myFarmListByVariety" parameterType="map"
        resultType="com.sp.app.farm.model.MyFarmSale">
  SELECT
    v.varietyNum,
    v.varietyName,
    SUM(TO_NUMBER(NVL(s.supplyQuantity, 0))) AS totalQty,
    NVL(SUM(
      TO_NUMBER(NVL(s.supplyQuantity,0))
      / NULLIF(TO_NUMBER(NVL(s.unitQuantity,1)), 0)
      * TO_NUMBER(NVL(s.unitPrice,0))
    ), 0) AS totalVarietyEarning
  FROM supply s
  JOIN variety v ON v.varietyNum = s.varietyNum
  <where>
    s.farmNum = #{farmNum}
    AND s.state &gt;= 5
    AND s.approvedDate IS NOT NULL
    <if test="productNumOnly != null and productNumOnly == 1">
      AND s.productNum IS NOT NULL
    </if>
    <if test="varietyNum != null and varietyNum &gt; 0">
      AND s.varietyNum = #{varietyNum}
    </if>
    <if test="kwd != null and kwd != ''">
      <choose>
        <when test="schType == 'varietyName'">
          AND LOWER(v.varietyName) LIKE '%' || LOWER(#{kwd}) || '%'
        </when>
        <when test="schType == 'coment'">
          AND LOWER(NVL(s.coment,'')) LIKE '%' || LOWER(#{kwd}) || '%'
        </when>
      </choose>
    </if>
  </where>
  GROUP BY v.varietyNum, v.varietyName
  ORDER BY totalVarietyEarning DESC, totalQty DESC
  OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
</select>

<select id="myFarmListByVarietyCount" parameterType="map" resultType="int">
  SELECT COUNT(*)
  FROM (
    SELECT v.varietyNum
    FROM supply s
    JOIN variety v ON v.varietyNum = s.varietyNum
    <where>
      s.farmNum = #{farmNum}
      AND s.state &gt;= 5
      AND s.approvedDate IS NOT NULL
      <if test="productNumOnly != null and productNumOnly == 1">
        AND s.productNum IS NOT NULL
      </if>
      <if test="varietyNum != null and varietyNum &gt; 0">
        AND s.varietyNum = #{varietyNum}
      </if>
      <if test="kwd != null and kwd != ''">
        <choose>
          <when test="schType == 'varietyName'">
            AND LOWER(v.varietyName) LIKE '%' || LOWER(#{kwd}) || '%'
          </when>
          <when test="schType == 'coment'">
            AND LOWER(NVL(s.coment,'')) LIKE '%' || LOWER(#{kwd}) || '%'
          </when>
        </choose>
      </if>
    </where>
    GROUP BY v.varietyNum
  )
</select>


</mapper>