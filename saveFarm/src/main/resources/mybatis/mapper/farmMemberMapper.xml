<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sp.app.mapper.FarmMemberMapper">
	<insert id="insertFarm" parameterType="com.sp.app.model.Farm">
<!-- 회원추가 -->
		INSERT INTO farm(farmNum, farmName, businessNumber, farmManager, farmTel, farmZip, farmAddress1, 
			farmAddress2, farmRegDate, farmerName, farmerTel, farmerId, farmerPwd, status, farmAccount)
		VALUES (farm_seq.NEXTVAL, #{farmName}, #{businessNumber}, #{farmManager}, #{farmTel}, #{farmZip}, #{farmAddress1},
			#{farmAddress2}, SYSDATE, #{farmerName}, #{farmerTel}, #{farmerId}, #{farmerPwd}, 0, #{farmAccount})
	</insert>
	
<!-- 정보수정, 비밀번호 재설정 -->
	<update id="updateFarm" parameterType="com.sp.app.model.Farm">
		UPDATE farm SET farmManager = #{farmManager}, farmTel = #{farmTel}, farmerTel = #{farmerTel},
			farmZip = #{farmZip}, farmAddress1 = #{farmAddress1}, farmAddress2 = #{farmAddress2},
			farmerName = #{farmerName}, farmerTel = #{farmerTel},farmAccount = #{farmAccount}
		WHERE farmerId = #{farmerId}
	</update>
	
	<update id="updateFarmName" parameterType="map">
		UPDATE farm SET farmName = #{farmName}
		WHERE farmNum = #{farmNum}
	</update>
	<update id="updateFarmManager" parameterType="map">
		UPDATE farm SET farmName = #{farmName}
		WHERE farmNum = #{farmNum}
	</update>
	
	<update id="updateStatus" parameterType="map">
		UPDATE farm SET status = #{status}
		WHERE farmNum = #{farmNum}
	</update>
	
	<update id="updatePassword" parameterType="map">
		UPDATE farm SET farmerPwd = #{farmerPwd}
		WHERE farmNum = #{farmNum}
	</update>

<!-- 삭제 -->	
	<delete id="deleteFarm" parameterType="map">
		DELETE FROM farm
		WHERE farmNum = #{farmNum}
	</delete>

<!-- 데이터 찾기 -->
	<!-- 농장번호로 정보찾기 -->
	<select id="findByFarmNum" parameterType="Long" resultType="com.sp.app.model.Farm">
		SELECT farmName, businessNumber, farmManager, farmTel, farmZip, farmAddress1, 
			farmAddress2, farmRegDate, farmerName, farmerTel, farmerId, farmerPwd, status, farmAccount
		FROM farm
		WHERE farmNum = ${farmNum}
	</select>
	
	<!-- 아이디 찾기 -->
	<select id="findFarmerId" parameterType="map" resultType="String">
		SELECT farmerId
		FROM farm
		WHERE businessNumber = #{businessNumber}, farmerName = #{farmerName}, farmerTel = #{farmerTel}
	</select>
	
	<!-- 아이디로 정보찾기 -->
	<select id="findByFarmerId" parameterType="String" resultType="com.sp.app.model.Farm">
		SELECT farmNum, farmName, businessNumber, farmManager, farmTel, farmZip, farmAddress1, 
			farmAddress2, farmRegDate, farmerName, farmerTel, farmerId, farmerPwd, status, farmAccount
		FROM farm
		WHERE farmerId = #{farmerId}
	</select>
	
	<!-- 사업장번호 등록여부 확인-->
	<select id="existsBusinessNumber" parameterType="String" resultType="int">
		SELECT COUNT(1)
		FROM farm		
		WHERE businessNumber = #{businessNumber}
	</select>
	
<!-- 농가 리스트 -->
	<!-- 공통 WHERE 블록 -->
	<sql id="farmWhere">
	  <where>
	    <!-- 상태: 사용할 때만 -->
	    <if test="useStatus">
	      AND status = #{status}
	    </if>
	
	    <!-- 등록일: 사용할 때만 (from~to 포함) -->
	    <if test="useDate">
	      AND farmRegDate &gt;= TO_DATE(#{fromDate}, 'YYYY-MM-DD')
	      AND farmRegDate &lt; TO_DATE(#{toDate},   'YYYY-MM-DD') + 1
	    </if>
	
	    <if test="kwd != null and kwd != ''">
	      <choose>
	        <when test="schType == 'farmerId'">
	          AND farmerId LIKE '%' || #{kwd} || '%'
	        </when>
	        <when test="schType == 'farmName'">
	          AND farmName LIKE '%' || #{kwd} || '%'
	        </when>
	        <when test="schType == 'businessNumber'">
	          AND REPLACE(businessNumber,'-','') LIKE '%' || REPLACE(#{kwd},'-','') || '%'
	        </when>
	        <when test="schType == 'farmerName'">
	          AND farmerName LIKE '%' || #{kwd} || '%'
	        </when>
	        <when test="schType == 'farmerTel'">
	          AND REPLACE(farmerTel,'-','') LIKE '%' || REPLACE(#{kwd},'-','') || '%'
	        </when>
	        <otherwise>
	          AND (
	               farmName LIKE '%' || #{kwd} || '%'
	            OR farmerId LIKE '%' || #{kwd} || '%'
	            OR REPLACE(businessNumber,'-','') LIKE '%' || REPLACE(#{kwd},'-','') || '%'
	            OR accountOwnerName LIKE '%' || #{kwd} || '%'
	          )
	        </otherwise>
	      </choose>
	    </if>
	  </where>
	</sql>
	
	<select id="listFarm" parameterType="map" resultType="com.sp.app.model.Farm">
		SELECT farmNum, farmName, businessNumber, farmManager, farmTel, farmZip, farmAddress1, 
			farmAddress2, farmRegDate, farmerName, farmerTel, farmerId, farmerPwd, status, farmAccount
		FROM farm
		<include refid="farmWhere"/>
		ORDER BY farmRegDate DESC, farmName ASC
		OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
	</select>
	
	<!-- 데이터 수 -->
	<select id="farmCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM farm
		<include refid="farmWhere"/>
	</select>

</mapper>