<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sp.app.mapper.PackageReviewMapper">
	<insert id="insertsubReview" parameterType="com.sp.app.model.packageReview">
		INSERT INTO subReview(subNum, subject, content ,regDate,star)
		VALUES(#{subNum}, #{subject}, #{content},SYSDATE, #{star})
	</insert>
	
	<insert id="insertsubImage" parameterType="com.sp.app.model.packageReview">
		INSERT subImage(imageNum, imagefilename, subNum)
		VALUES(subImage_seq.NEXTVAL, #{imagefilename}, #{sub})
	</insert>
	
	<select id="countReview" resultType="Integer">
		SELECT NVL(COUNT(*), 0) count
		FROM subReview
	</select>
	
	
	<select id="listReview" parameterType="map" resultType="com.sp.app.model.packageReview">
		SELECT sr.subNum, subject, content, TO_CHAR(sr.regDate, 'YYYY-MM-DD'), star , f.imageFilename, m2.name, ss.subMonth
		FROM subReview sr
		JOIN subStatus ss ON sr.subNum = ss.subNum
		LEFT OUTER JOIN member2 m2 ON  ss.memberId = m2.memberId
		LEFT OUTER JOIN (
			SELECT subNum, LISTAGG(imageFilename, ',') WITHIN GROUP(ORDER BY imageNum) imageFilename 
            FROM subImage
            GROUP BY subNum	
		) f ON f.subNum = sr.subNum
		ORDER BY sr.regDate DESC
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>

	
	<select id="listsubImage" parameterType="long" resultType="com.sp.app.model.packageReview">
		SELECT imageNum, subNum, imageFilename
		FROm subImage
		WHERE subNum = #{subNum}
	</select>
	
	
</mapper>